<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FinGPT • Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="./css/styles.css"/>
</head>
<body>
  <header class="topbar">
    <div class="brand">FinGPT • Search</div>
    <nav>
      <a href="./search.html">Search</a>
      <a href="./clusters.html">Clusters</a>
      <a href="https://github.com/" target="_blank" class="muted">Git</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <div class="row gap">
        <input id="q" class="input flex1" placeholder="Type keywords… (e.g., fed, earnings, oil)"/>
        <button id="btnSearch" class="btn">Search</button>
      </div>
      <div class="row gap mt8">
        <label class="lbl">Page size
          <select id="pageSize" class="select">
            <option>10</option><option selected>20</option><option>50</option><option>100</option>
          </select>
        </label>
        <label class="lbl">Window (hours)
          <select id="windowHours" class="select">
            <option value="72">72</option>
            <option value="168">168</option>
            <option value="720" selected>720</option>
            <option value="2160">2160</option>
          </select>
        </label>
        <label class="lbl">Mode
          <select id="mode" class="select">
            <option value="hybrid" selected>Hybrid</option>
            <option value="keyword">Keyword-only</option>
            <option value="embedding">Embedding-only</option>
          </select>
        </label>
        <label class="lbl">Cluster labels
          <input id="useLatestRun" type="checkbox" checked/>
        </label>
      </div>
    </section>

    <section id="resultsMeta" class="muted mt8"></section>
    <section id="results" class="list mt8"></section>

    <section class="row gap center mt12">
      <button id="prev" class="btn btn-ghost">Prev</button>
      <span id="pageInfo" class="muted"></span>
      <button id="next" class="btn btn-ghost">Next</button>
    </section>
  </main>

  <script src="./config.js"></script>
  <script src="./js/api.js"></script>
  <script>
    // ---- API base: prefer config.js, otherwise fallback to localhost:8000
    const API_BASE = (typeof window !== "undefined" && window.FINGPT_API) ? window.FINGPT_API : "http://localhost:8000";
    const API = makeApi(API_BASE);
    document.title = `FinGPT • Search — ${API_BASE}`;

    // ---- state ----
    let page = 1;

    // elements
    const qEl = document.getElementById('q');
    const pageSizeEl = document.getElementById('pageSize');
    const windowHoursEl = document.getElementById('windowHours');
    const modeEl = document.getElementById('mode');
    const useLatestRunEl = document.getElementById('useLatestRun');

    const resultsEl = document.getElementById('results');
    const metaEl = document.getElementById('resultsMeta');
    const pageInfoEl = document.getElementById('pageInfo');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');

    // health check for quick feedback
    (async () => {
      try {
        const r = await fetch(API_BASE + "/healthz");
        const js = await r.json();
        console.log("API health:", js);
      } catch (e) {
        console.error("API not reachable at", API_BASE, e);
        metaEl.innerHTML = `<span style="color:#c00">API not reachable at ${API_BASE} — start the server or check the port.</span>`;
      }
    })();

    async function runSearch(goTo = 1) {
      page = goTo;
      const q = (qEl.value || "").trim();
      if (!q) {
        resultsEl.innerHTML = "";
        metaEl.textContent = "Type some keywords.";
        pageInfoEl.textContent = "";
        btnPrev.disabled = true;
        btnNext.disabled = true;
        return;
      }

      const ps = Number(pageSizeEl.value);
      const wh = Number(windowHoursEl.value);
      const useLatestRun = useLatestRunEl.checked;

      resultsEl.innerHTML = '<div class="muted">Loading…</div>';
      metaEl.textContent = '';
      pageInfoEl.textContent = `Page ${page}`;
      btnPrev.disabled = true; btnNext.disabled = true;

      try {
        const data = await API.search({
          q,
          page,
          page_size: ps,
          window_hours: wh,
          use_latest_run: useLatestRun
        });
        console.log("[search] response:", data);

        // Optional client-side view modes (visual only)
        if (modeEl.value !== "hybrid" && Array.isArray(data.hits)) {
          if (modeEl.value === "keyword") {
            const terms = q.toLowerCase().split(/\s+/).filter(Boolean);
            for (const h of data.hits) {
              const t = (h.title || "").toLowerCase();
              const s = (h.summary_text || "").toLowerCase();
              let sc = 0;
              for (const term of terms) {
                const re = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), "g");
                sc += (t.match(re) || []).length * 2 + (s.match(re) || []).length;
              }
              h.score = sc;
            }
            data.hits.sort((a,b)=>b.score-a.score);
          }
        }

        renderResults(data, ps);
      } catch (err) {
        console.error("Fetch/search failed:", err);
        resultsEl.innerHTML = "";
        metaEl.innerHTML = `<span style="color:#c00">Error: ${escapeHtml(String(err))}</span>`;
        pageInfoEl.textContent = `Page ${page}`;
        btnPrev.disabled = page <= 1;
        btnNext.disabled = true;
      }
    }

    function renderResults(js, pageSize) {
      const total = Number(js?.total_candidates ?? 0);
      const returned = Number(js?.returned ?? 0);
      metaEl.textContent = `${returned} / ${total} results`;
      pageInfoEl.textContent = `Page ${Number(js?.page ?? page)}`;

      resultsEl.innerHTML = "";
      const hits = Array.isArray(js?.hits) ? js.hits : [];

      if (hits.length === 0) {
        resultsEl.innerHTML = `<div class="muted">No results found.</div>`;
      } else {
        for (const h of hits) {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div class="row space">
              <div class="title"><a href="${h.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(h.title || "(untitled)")}</a></div>
              <div class="score">score ${Number(h.score).toFixed(3)}</div>
            </div>
            <div class="muted small">${escapeHtml(h.source || "")} • ${h.published_at || "N/A"}${h.cluster_label ? " • " + escapeHtml(h.cluster_label) : ""}</div>
            ${h.summary_text ? `<pre class="summary">${escapeHtml(h.summary_text)}</pre>` : ""}
          `;
          resultsEl.appendChild(div);
        }
      }

      btnPrev.disabled = (page <= 1);
      btnNext.disabled = (returned === 0 || (page * pageSize >= total));
    }

    document.getElementById('btnSearch').onclick = () => runSearch(1);
    qEl.addEventListener('keydown', e => { if (e.key === 'Enter') runSearch(1); });
    btnPrev.onclick = () => runSearch(page - 1);
    btnNext.onclick = () => runSearch(page + 1);

    function escapeHtml(s) {
      s = String(s || "");
      return s.replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    qEl.focus();
  </script>
</body>
</html>
